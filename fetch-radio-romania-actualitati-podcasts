#!/bin/bash

# Copyright (C) 2017-2020 Andrei Pavel, andrei.pavel@cti.pub.ro
# Licensed under the MIT License

# Header
SCRIPT_PATH="$(dirname "$(readlink -f "${0}")")"
. "${SCRIPT_PATH}/lib/header"
. "${SCRIPT_PATH}/lib/spinner"

argument 'simple' 'audio' '-a|--audio' "download audio files instead of creating HTML redirects to romania-actualitati.ro's storage"

parse-parameters "${@}"

# Default values
test -z "${audio+x}" && audio=false

#------------------------------------------------------------------------------#

function archive() {
  month="$(printf '%s' "${editions[${i}]}" | xargs | cut -d ' ' -f 4)"
  year="$(printf '%s' "${editions[${i}]}" | xargs | cut -d ' ' -f 5)"
  month_directory="${directory}/${year}/${month}"
  mkdir -p "${month_directory}"
  cp -p "${auxiliary}" "${month_directory}/${filename}"
  cp -p "${auxiliary}" "${directory}/${filename}"
}

function download() {
  if wget -O "${auxiliary}" "${urls[${i}]}" &> /dev/null; then
    archive
  else
    printf 'Could not download audio file %s' "${urls[${i}]}" >&2
  fi
}

function redirect_html() {
  printf "\
<html><head><meta http-equiv=\"refresh\" content=\"0;url=%s\" /><title>Redirecting...</title></head><body>Redirecting.... Click <a href=\"%s\">here</a> to hurry things up.</body></html>
" "${urls[${i}]}" "${urls[${i}]}" > "${auxiliary}"
  archive
}

function filename() {
  if ${audio}; then
    filename="$(printf '%s' "${editions[${i}]}" | xargs).mp3"
  else
    filename="$(printf '%s' "${editions[${i}]}" | xargs)"
  fi
}

function retrieve() {
  if ${audio}; then
    download
  else
    redirect_html
  fi
}

function fetch() {
  local name="${1}"
  local url="${2}"

  directory="/usr/share/radio-romania-actualitati-podcasts/${name}"
  auxiliary="/tmp/${name}.mp3"

  if [[ ! -e "${directory}" ]]; then
    mkdir -p "${directory}"
  fi

  editions=$(curl -s "http://www.romania-actualitati.ro/Podcast/${url}" | pup 'div.podcastilisting a text{}')
  urls=$(curl -s "http://www.romania-actualitati.ro/Podcast/${url}" | pup 'div.podcastilisting a attr{href}' | grep -v '#')

  SAVEIFS="${IFS}"
  IFS=$'\n'

  editions=( ${editions} )

  urls=( ${urls} )

  IFS="${SAVEIFS}"

  spared_files=
  i=$(( ${#urls[@]} - 1 ))
  while (( i >= 0 )); do
    start-spinner "${name} - ${editions[${i}]}"
    filename
    spared_files+="-not -name \"${filename}\" "
    if [[ ! -f "${directory}/${filename}" ]]; then
      retrieve
    fi
    i=$(( i - 1 ))
    stop-spinner 0
  done

  eval find "${directory}" -maxdepth 1 -type f ${spared_files} -delete

  rm -f "${auxiliary}"
}

function get_list_manually() {
  list=(
    vatra_luminoasa/36
    un_minut_de_sanatate/20
    teatru_national_radiofonic/29
    sitcom_undeva_in_28/33
    serviciul_de_noapte/25
    semnele_lumii/21
    probleme_la_zi/22
    printre_stele/26
    povesti_cu_care_cresti/17
    o_vorba_buna/14
    multi_kulti/37
    minutul_de_limba_romana/38
    lumina_credintei/35
    lectia_de_gramatica/13
    la_dispozitia_dumneavoastra_reteta_de_sanatate/18
    la_dispozitia_dumneavoastra/39
    istorica/4
    euroatlantica/8
    de_la_la_infinit/34
    documentarele_radio_romania_actualitati/5
    colectia_de_muzica_omul_cu_chitara/27
    coronavirus_la_obiectiv_romania/40
    buna_ziua_caciula_ca_stapanul_n_are_guracod_de_bune_maniere/15
    antena_partidelor_parlamentare/30
    agenda_globala/1
    accente_europene/24
    150_de_cuvinte/12
  )
}

function get_list_automatically() {
  list=( $(curl -s "http://www.romania-actualitati.ro/Podcast" | pup 'div.podcastiTEM h2 a attr{href}' | sed 's#/Podcast/##g' | sort -ruV) )
}

get_list_automatically
for item in ${list[@]}; do
  name="$(cut -d '/' -f 1 <<< ${item})"
  name="${name//_/-}"
  fetch ${name} ${item}
done
